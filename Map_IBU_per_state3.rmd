---
title: "Median_IBU"
author: "Paritosh Rai"
date: "6/23/2019"
output: html_document
---

```{r message=FALSE, warning=FALSE, include=TRUE}

library(tidyverse)
library(ggplot2)
library(stringr)
library(viridis)
library(dplyr)
library(usmap)

#read.csv("beers.csv")
beers<-read.csv("beers.csv")
#Read in Brewries.csv file
brewires<-read.csv("Brewries.csv")
#Merge beers and Brewieres data frames into beers_brew
beers_brew<-merge(data.frame(beers),data.frame(brewires), by.x = "Brewery_id",by.y="Brew_ID")
#Create a new data frame IBU. 
IBU <- data.frame(beers_brew$Beer_ID, beers_brew$State, beers_brew$IBU)
#Update the column names of IBU to Beer ID, State, and IBU.
names(IBU) <- c("Beer_ID","State","IBU")
#Remove any null values in the new table.
IBU <- na.omit(IBU)
#Create a function to calculate the median.
myFun <- function(x) { median = median(x)}
#Create a new dataframe Median IBU. The function will be used to calculate median IBU per-state.
MedianIBU <- as.data.frame.table(tapply(IBU$IBU, IBU$State, myFun))
#Update the column names of MedianIBU to State and Median IBU.
names(MedianIBU) <- c("State","Median_IBU")
#Remove SD because it does not have a median value
MedianIBU <- na.omit(MedianIBU)
#plot us map using states file 
#keep fill value to "0" so fill values remains numerical
#data(us_map("state"))
States_Map<-ggplot(us_map("state")) + 
  geom_polygon(aes(x = long, y = lat, fill = 0, group = group), color = "white")
 
#guides(fill = FALSE) 
state_name_abb<-read.csv("https://raw.githubusercontent.com/Chinchillin1981/CaseStudy1_Matt_Paritosh/a5e17a7b0820dcee785e006653d05874465fc2e7/state_name_abb.csv", header=FALSE,sep=",")


#convert to data frame
state_name_abb<-data.frame(state_name_abb)
#move data from MedianIBU to MedianIBU1
MedianIBU1<-MedianIBU

#move data from MedianIBU to MedianIBU1
MedianIBU1<-data.frame(MedianIBU1)
#head(MedianIBU1)
MedianIBU1<-within(MedianIBU,V2<- substring(MedianIBU$State,2,3))
#head(BeerMedianIBU1)
#Merge BrewCount and state_name_abb table with state.abbState
BeerMedianIBU_M<-merge(data.frame(MedianIBU1),data.frame(state_name_abb),by.x="V2",by.y="V2")
#view the merger
#head(BeerMedianIBU_M)
#Change all charater in state name to lower cast as map file use lower case for statename
BeerMedianIBU_M<-within(BeerMedianIBU_M,l_state<-tolower(V1))
#verify the converstion
#head(BeerMedianIBU_M)
#head(us_map("state"))
#merge the BrewCount_M file with state map files using state full name
US_State_Brew_IBU<-merge(data.frame(us_map("state")),data.frame(BeerMedianIBU_M),by.x = "full",by.y="V1")

write.csv(US_State_Brew_IBU,"C:\\Paritosh\\SMU\\6306 Doing Data Science\\Case_Study_1\\CaseStudy1_Matt_Paritosh\\IBU0.csv")
US_State_Brew_IBU<-read.csv("https://raw.githubusercontent.com/Chinchillin1981/CaseStudy1_Matt_Paritosh/master/US_State_Brew_IBU.csv", header=TRUE,sep=",")
#Convert to data frame
US_State_Brew_IBU<-data.frame(US_State_Brew_IBU)


#Plot the map
#comment out guide so we get the legent
state_brew_IBU_map<-States_Map  +
  geom_polygon(data = US_State_Brew_IBU,aes(x = long, y = lat, fill = Median_IBU , group = group),color = "white") +
  #guides(fill=FALSE) +
  ggtitle("International Bitterness Unit (IBU)") 
theme_void()
#state_brew_IBU_map 
#put map with log scale
state_brew_IBU_map1<-state_brew_IBU_map+
  scale_fill_gradientn(colours = rev(rainbow(7)))
guides(fill=TRUE)#,
breaks = c(2, 4, 10, 100, 1000, 10000)#,
trans = "log10"

state_brew_IBU_map1

```